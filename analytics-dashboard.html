<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HighPay Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-card h3 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-card.primary .value { color: #3498db; }
        .metric-card.success .value { color: #27ae60; }
        .metric-card.warning .value { color: #f39c12; }
        .metric-card.danger .value { color: #e74c3c; }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group input, .control-group select, .control-group button {
            padding: 10px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .control-group button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .control-group button:hover {
            background: #2980b9;
        }
        
        .real-time-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .real-time-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: white;
        }
        
        .activity-icon.clock-in { background: #27ae60; }
        .activity-icon.clock-out { background: #e74c3c; }
        .activity-icon.break { background: #f39c12; }
        
        .activity-details h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .activity-details p {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        
        .status-indicator.connected {
            background: #27ae60;
        }
        
        .status-indicator.disconnected {
            background: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator disconnected" id="connectionStatus">
        Disconnected
    </div>

    <div class="dashboard">
        <div class="header">
            <h1>üìä HighPay Analytics Dashboard</h1>
            <p class="subtitle">Real-time workforce insights and analytics</p>
        </div>

        <div class="controls">
            <h3>üîß Dashboard Controls</h3>
            <div class="control-group">
                <input type="text" id="tokenInput" placeholder="Enter JWT Token" style="width: 300px;">
                <select id="timeframeSelect">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
                <button onclick="loadDashboard()">üîÑ Refresh Dashboard</button>
                <button onclick="connectWebSocket()">üîå Connect Real-time</button>
                <button onclick="exportData()">üì§ Export Data</button>
            </div>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card primary">
                <h3>üë• Total Employees</h3>
                <div class="value" id="totalEmployees">-</div>
                <p>Active workforce</p>
            </div>
            <div class="metric-card success">
                <h3>‚è∞ Hours This Period</h3>
                <div class="value" id="totalHours">-</div>
                <p>Total hours worked</p>
            </div>
            <div class="metric-card warning">
                <h3>üí∞ Total Payroll</h3>
                <div class="value" id="totalPayroll">-</div>
                <p>Gross pay amount</p>
            </div>
            <div class="metric-card danger">
                <h3>üî• Currently Working</h3>
                <div class="value" id="currentlyWorking">-</div>
                <p>Employees clocked in</p>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>üìà Hours Trend</h3>
                <canvas id="hoursTrendChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>üíº Department Breakdown</h3>
                <canvas id="departmentChart"></canvas>
            </div>
        </div>

        <div class="real-time-section">
            <h3>‚ö° Real-time Activity Feed</h3>
            <div class="activity-feed" id="activityFeed">
                <div class="activity-item">
                    <div class="activity-icon clock-in">IN</div>
                    <div class="activity-details">
                        <h4>No recent activity</h4>
                        <p>Connect to WebSocket to see live updates</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let hoursTrendChart = null;
        let departmentChart = null;
        let token = '';

        // Initialize charts
        function initializeCharts() {
            // Hours Trend Chart
            const hoursCtx = document.getElementById('hoursTrendChart').getContext('2d');
            hoursTrendChart = new Chart(hoursCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Hours Worked',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Department Chart
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(deptCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load dashboard data
        async function loadDashboard() {
            const token = document.getElementById('tokenInput').value;
            const timeframe = document.getElementById('timeframeSelect').value;

            if (!token) {
                alert('Please enter a JWT token');
                return;
            }

            try {
                // Load dashboard analytics
                const response = await fetch(`http://localhost:3000/api/v1/analytics/dashboard?timeframe=${timeframe}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updateDashboard(data.data);

                // Load real-time data
                const realtimeResponse = await fetch('http://localhost:3000/api/v1/analytics/realtime', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (realtimeResponse.ok) {
                    const realtimeData = await realtimeResponse.json();
                    updateRealTimeData(realtimeData.data);
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard data. Please check your token and try again.');
            }
        }

        // Update dashboard with data
        function updateDashboard(data) {
            // Update metrics
            document.getElementById('totalEmployees').textContent = data.employee?.total || 0;
            document.getElementById('totalHours').textContent = Math.round(data.timeTracking?.totalHours || 0);
            document.getElementById('totalPayroll').textContent = '$' + (data.payroll?.totalGrossPay || 0).toLocaleString();

            // Update charts with sample data
            updateHoursTrendChart();
            updateDepartmentChart();
        }

        // Update real-time data
        function updateRealTimeData(data) {
            document.getElementById('currentlyWorking').textContent = data.currentlyWorking?.length || 0;
            
            if (data.recentActivity && data.recentActivity.length > 0) {
                updateActivityFeed(data.recentActivity);
            }
        }

        // Update hours trend chart
        function updateHoursTrendChart() {
            const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const data = [42, 38, 45, 40, 37];
            
            hoursTrendChart.data.labels = labels;
            hoursTrendChart.data.datasets[0].data = data;
            hoursTrendChart.update();
        }

        // Update department chart
        function updateDepartmentChart() {
            const labels = ['Engineering', 'Sales', 'Marketing', 'HR', 'Finance'];
            const data = [35, 25, 20, 10, 10];
            
            departmentChart.data.labels = labels;
            departmentChart.data.datasets[0].data = data;
            departmentChart.update();
        }

        // Update activity feed
        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = '';

            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                const iconClass = activity.type === 'clock_in' ? 'clock-in' : 
                                activity.type === 'clock_out' ? 'clock-out' : 'break';
                const iconText = activity.type === 'clock_in' ? 'IN' : 
                               activity.type === 'clock_out' ? 'OUT' : 'BR';
                
                item.innerHTML = `
                    <div class="activity-icon ${iconClass}">${iconText}</div>
                    <div class="activity-details">
                        <h4>${activity.firstName} ${activity.lastName}</h4>
                        <p>${activity.type.replace('_', ' ').toUpperCase()} at ${new Date(activity.timestamp).toLocaleTimeString()}</p>
                    </div>
                `;
                
                feed.appendChild(item);
            });
        }

        // Connect to WebSocket
        function connectWebSocket() {
            const token = document.getElementById('tokenInput').value;
            
            if (!token) {
                alert('Please enter a JWT token first');
                return;
            }

            try {
                ws = new WebSocket(`ws://localhost:3000/ws?token=${token}`);
                
                ws.onopen = function() {
                    updateConnectionStatus(true);
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onclose = function() {
                    updateConnectionStatus(false);
                    console.log('WebSocket disconnected');
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
                
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                alert('Failed to connect to WebSocket');
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            console.log('WebSocket message:', data);
            
            if (data.type === 'time_punch_created' || data.type === 'employee_time_punch') {
                // Refresh real-time data
                loadDashboard();
                
                // Add to activity feed
                const feed = document.getElementById('activityFeed');
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.style.animation = 'fadeIn 0.5s ease-in';
                
                const iconClass = data.data.type === 'clock_in' ? 'clock-in' : 'clock-out';
                const iconText = data.data.type === 'clock_in' ? 'IN' : 'OUT';
                
                item.innerHTML = `
                    <div class="activity-icon ${iconClass}">${iconText}</div>
                    <div class="activity-details">
                        <h4>Live Update</h4>
                        <p>${data.data.type.replace('_', ' ').toUpperCase()} - Just now</p>
                    </div>
                `;
                
                feed.insertBefore(item, feed.firstChild);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'Connected ‚úÖ';
                status.className = 'status-indicator connected';
            } else {
                status.textContent = 'Disconnected ‚ùå';
                status.className = 'status-indicator disconnected';
            }
        }

        // Export data
        function exportData() {
            const token = document.getElementById('tokenInput').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            
            if (!token) {
                alert('Please enter a JWT token');
                return;
            }
            
            window.open(`http://localhost:3000/api/v1/analytics/export?type=dashboard&format=json&timeframe=${timeframe}&token=${token}`);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Auto-refresh every 30 seconds if connected
            setInterval(() => {
                const token = document.getElementById('tokenInput').value;
                if (token && ws && ws.readyState === WebSocket.OPEN) {
                    loadDashboard();
                }
            }, 30000);
        });

        // Add fade in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

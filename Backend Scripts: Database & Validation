// src/database/connection.js
const { Pool } = require('pg');
require('dotenv').config();

const pool = new Pool({
Â  host: process.env.DB_HOST,
Â  port: process.env.DB_PORT,
Â  database: process.env.DB_NAME,
Â  user: process.env.DB_USER,
Â  password: process.env.DB_PASSWORD,
Â  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
Â  max: 20,
Â  idleTimeoutMillis: 30000,
Â  connectionTimeoutMillis: 2000,
});

// Test connection
pool.on('connect', () => {
Â  console.log('ðŸ—„ï¸  Connected to PostgreSQL database');
});

pool.on('error', (err) => {
Â  console.error('ðŸ’¥ PostgreSQL connection error:', err);
Â  process.exit(-1);
});

module.exports = {
Â  query: (text, params) => pool.query(text, params),
Â  pool
};

// src/database/migrate.js
const fs = require('fs');
const path = require('path');
const db = require('./connection');

async function runMigrations() {
Â  try {
Â  Â  console.log('ðŸš€ Running database migrations...');
Â  Â  
Â  Â  // Read and execute schema.sql
Â  Â  const schemaPath = path.join(__dirname, 'schema.sql');
Â  Â  const schema = fs.readFileSync(schemaPath, 'utf8');
Â  Â  
Â  Â  await db.query(schema);
Â  Â  
Â  Â  console.log('âœ… Database migrations completed successfully!');
    // We shouldn't exit the process if this is part of a larger app startup
Â  } catch (error) {
Â  Â  console.error('ðŸ’¥ Migration failed:', error);
Â  Â  process.exit(1); // Exit with error on migration failure
Â  }
}

// Ensure the pool is closed after the script runs
runMigrations().finally(() => {
    db.pool.end();
});


// src/database/seed.js
const bcrypt = require('bcryptjs');
const db = require('./connection');

async function seedDatabase() {
Â  const client = await db.pool.connect();
Â  try {
    await client.query('BEGIN');
Â  Â  console.log('ðŸŒ± Seeding database with initial data...');

Â  Â  // Create a demo company
Â  Â  const companyResult = await client.query(`
Â  Â  Â  INSERT INTO companies (name, address, phone, email, tax_id)
Â  Â  Â  VALUES ($1, $2, $3, $4, $5)
Â  Â  Â  RETURNING id
Â  Â  `, [
Â  Â  Â  'Demo Company Inc.',
Â  Â  Â  '123 Business St, San Francisco, CA 94105',
Â  Â  Â  '(555) 123-4567',
Â  Â  Â  'admin@democompany.com',
Â  Â  Â  '12-3456789'
Â  Â  ]);

Â  Â  const companyId = companyResult.rows[0].id;

Â  Â  // Create job roles
Â  Â  const jobRoleResults = await client.query(`
Â  Â  Â  INSERT INTO job_roles (company_id, title, hourly_rate, overtime_rate, description)
Â  Â  Â  VALUES 
Â  Â  Â  Â  ($1, 'Manager', 25.00, 37.50, 'Team management and operations'),
Â  Â  Â  Â  ($1, 'Full-time Employee', 18.00, 27.00, 'Standard full-time position'),
Â  Â  Â  Â  ($1, 'Part-time Employee', 15.00, 22.50, 'Part-time hourly position')
Â  Â  Â  RETURNING id, title
Â  Â  `, [companyId]);

Â  Â  const managerRoleId = jobRoleResults.rows.find(r => r.title === 'Manager').id;
Â  Â  const employeeRoleId = jobRoleResults.rows.find(r => r.title === 'Full-time Employee').id;

Â  Â  // Create admin user
Â  Â  const adminPasswordHash = await bcrypt.hash('admin123', 12);
Â  Â  await client.query(`
Â  Â  Â  INSERT INTO users (company_id, job_role_id, email, password_hash, first_name, last_name, role_type, hire_date)
Â  Â  Â  VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
Â  Â  `, [
Â  Â  Â  companyId,
Â  Â  Â  managerRoleId,
Â  Â  Â  'admin@democompany.com',
Â  Â  Â  adminPasswordHash,
Â  Â  Â  'Admin',
Â  Â  Â  'User',
Â  Â  Â  'admin',
Â  Â  Â  new Date().toISOString().split('T')[0]
Â  Â  ]);

Â  Â  // Create demo employees
Â  Â  const demoEmployees = [
Â  Â  Â  { firstName: 'John', lastName: 'Doe', email: 'john.doe@democompany.com' },
Â  Â  Â  { firstName: 'Jane', lastName: 'Smith', email: 'jane.smith@democompany.com' },
Â  Â  Â  { firstName: 'Mike', lastName: 'Johnson', email: 'mike.johnson@democompany.com' }
Â  Â  ];

Â  Â  for (const employee of demoEmployees) {
Â  Â  Â  const passwordHash = await bcrypt.hash('employee123', 12);
Â  Â  Â  await client.query(`
Â  Â  Â  Â  INSERT INTO users (company_id, job_role_id, email, password_hash, first_name, last_name, role_type, hire_date)
Â  Â  Â  Â  VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
Â  Â  Â  `, [
Â  Â  Â  Â  companyId,
Â  Â  Â  Â  employeeRoleId,
Â  Â  Â  Â  employee.email,
Â  Â  Â  Â  passwordHash,
Â  Â  Â  Â  employee.firstName,
Â  Â  Â  Â  employee.lastName,
Â  Â  Â  Â  'employee',
Â  Â  Â  Â  new Date().toISOString().split('T')[0]
Â  Â  Â  ]);
Â  Â  }

    await client.query('COMMIT');
Â  Â  console.log('âœ… Database seeded successfully!');
Â  Â  console.log('ðŸ“§ Admin login: admin@democompany.com / admin123');
Â  Â  console.log('ðŸ“§ Employee login: john.doe@democompany.com / employee123');
Â  Â  
Â  } catch (error) {
    await client.query('ROLLBACK');
Â  Â  console.error('ðŸ’¥ Seeding failed:', error);
Â  } finally {
    client.release();
  }
}

// Ensure the pool is closed after the script runs
seedDatabase().finally(() => {
    db.pool.end();
});

// src/utils/validation.js
const { body, validationResult } = require('express-validator');

const handleValidationErrors = (req, res, next) => {
Â  const errors = validationResult(req);
Â  if (!errors.isEmpty()) {
Â  Â  return res.status(400).json({
Â  Â  Â  success: false,
Â  Â  Â  error: {
Â  Â  Â  Â  code: 'VALIDATION_ERROR',
Â  Â  Â  Â  message: 'Invalid input data',
Â  Â  Â  Â  details: errors.array()
Â  Â  Â  }
Â  Â  });
Â  }
Â  next();
};

const validateRegistration = [
Â  body('email').isEmail().normalizeEmail(),
Â  body('password').isLength({ min: 6 }).withMessage('Password must be at least 6 characters'),
Â  body('firstName').trim().isLength({ min: 1 }).withMessage('First name is required'),
Â  body('lastName').trim().isLength({ min: 1 }).withMessage('Last name is required'),
Â  handleValidationErrors
];

const validateLogin = [
Â  body('email').isEmail().normalizeEmail(),
Â  body('password').exists().withMessage('Password is required'),
Â  handleValidationErrors
];

const validateTimePunch = [
Â  body('type').isIn(['in', 'out']).withMessage('Type must be "in" or "out"'),
Â  body('timestamp').isISO8601().withMessage('Valid timestamp required'),
Â  handleValidationErrors
];

module.exports = {
Â  handleValidationErrors,
Â  validateRegistration,
Â  validateLogin,
Â  validateTimePunch
};
